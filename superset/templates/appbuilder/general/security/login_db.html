{% extends "appbuilder/base.html" %}

{% block content %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 判断是否在企业微信环境
    function isWeCom() {
      const ua = navigator.userAgent.toLowerCase();
      console.log('User Agent:', ua); // 记录用户代理字符串

      // 判断是否是企业微信
      const isWxWork = /wxwork/i.test(ua);
      // 判断是否是微信环境
      const isWeixin = /micromessenger/i.test(ua);
      // 判断是否是移动设备
      const isMobile = /mobile|android|iphone|ipad/i.test(ua);
      
      // 企业微信移动端
      if (isWxWork && isWeixin && isMobile) {
        return true;
      }
      
      // 企业微信桌面端
      if (isWxWork && !isWeixin) {
        return true;
      }
      
      return false;
    }

    // 如果是企业微信环境，自动跳转到企业微信登录
    if (isWeCom()) {
      console.log('检测到企业微信环境');
      try {
        const loginUrl = 'https://open.weixin.qq.com/connect/oauth2/authorize?' + 
          `appid={{ config.WECOM_CORP_ID }}` + 
          `&redirect_uri={{ config.WECOM_REDIRECT_URI | urlencode }}` + 
          '&response_type=code' + 
          '&scope=snsapi_base' + 
          '&state=STATE' + 
          `&agentid={{ config.WECOM_AGENT_ID }}` + 
          '#wechat_redirect';
        console.log('Redirecting to:', loginUrl); // 记录跳转的 URL
        window.location.href = loginUrl;
      } catch (error) {
        console.error('Error during redirect:', error); // 记录错误信息
      }
    }
  });
</script>

<div class="container">
    <div id="loginbox" style="margin-top:50px;" class="mainbox col-md-6 col-md-offset-3 col-sm-8 col-sm-offset-2">
        <div class="panel panel-primary">
            <div class="panel-heading">
                <div class="panel-title">{{ title }}</div>
            </div>
            <div style="padding-top:30px" class="panel-body">
                {% if request.args.get('provider') == 'wecom' %}
                    <div class="text-center">
                        <h3>{{ _("Choose your authentication provider:") }}</h3>
                        <div style="margin-top: 30px;">
                            <a href="https://open.work.weixin.qq.com/wwopen/sso/qrConnect?appid={{ config.WECOM_CORP_ID }}&agentid={{ config.WECOM_AGENT_ID }}&redirect_uri={{ config.WECOM_REDIRECT_URI }}" class="btn btn-block" style="background-color: #1890ff; color: white; border: none; padding: 8px;">
                                <i class="fa fa-wechat"></i> {{ _('企业微信登录') }}
                            </a>
                        </div>
                        <div style="margin-top: 20px;">
                            <a href="{{ url_for('AuthDBView.login') }}" class="text-primary">
                                {{ _('使用用户名密码登录') }}
                            </a>
                        </div>
                    </div>
                {% else %}
                    <form class="form" action="" method="post" name="login">
                        {{ form.hidden_tag() }}
                        <div class="help-block">{{ _("Enter your login and password below:") }}</div>
                        <div class="control-group">
                            <label class="control-label" for="username">{{ _("USERNAME:") }}</label>
                            <div class="controls">
                                <input class="form-control" id="username" name="username" type="text" />
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label" for="password">{{ _("PASSWORD:") }}</label>
                            <div class="controls">
                                <input class="form-control" id="password" name="password" type="password" />
                            </div>
                        </div>
                        <div class="control-group">
                            <div class="controls">
                                <div>
                                    <input class="btn btn-block" type="submit" value="{{ _('Sign In') }}" style="background-color: #00A699; color: white; border: none; padding: 8px;"/>
                                </div>
                                <div style="margin-top: 20px; text-align: center;">
                                    <a href="{{ url_for('AuthDBView.login', provider='wecom') }}" class="btn btn-block" style="background-color: #1890ff; color: white; border: none; padding: 8px;">
                                        <i class="fa fa-wechat"></i> {{ _('企业微信登录') }}
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}